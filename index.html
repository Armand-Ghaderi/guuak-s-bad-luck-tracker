<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Guuak's bad Luck Tracker</title>
<style>
/* --- GLOBAL STYLES --- */
body { font-family: Georgia, serif; background:#0f1a2b; color:#e8d7c3; padding:20px; }
h1 { text-align:center; color:#d4af37; margin-bottom:20px; }
a { color:#d4af37; text-decoration:none; }

/* --- TABS --- */
.tabs { display:flex; justify-content:center; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
.tab { padding:10px 16px; border:2px solid #8b7355; border-radius:6px; cursor:pointer; background:#1b2b47; color:#e8d7c3; transition:0.3s; }
.tab.active { background:#d4af37; color:#1b2b47; }

/* --- SECTIONS --- */
.section { display:none; border:2px solid #8b7355; padding:20px; border-radius:8px; background:#1b2b47; opacity:0; transform:translateY(6px); transition:opacity .35s ease, transform .35s ease; }
.section.active { display:block; opacity:1; transform:translateY(0); }
.section-title { font-size:1.6em; text-align:center; color:#d4af37; margin-bottom:15px; }

/* --- DICE SELECTION --- */
.dice-container { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:16px; margin-bottom:20px; }
.dice-item { text-align:center; }
.dice-icon { width:70px; height:70px; border:2px solid #d4af37; border-radius:8px; background:#8b7355; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:.2s; margin:0 auto; }
.dice-icon.selected { background:#d4af37; color:#1b2b47; transform:scale(1.1); }
.dice-controls { margin-top:8px; display:flex; justify-content:center; gap:6px; }
.arrow-btn { width:32px; height:32px; background:#4a3f35; border:1px solid #8b7355; color:#d4af37; cursor:pointer; border-radius:4px; }
.dice-count { font-weight:bold; }
.validate-btn { padding:12px; margin-top:10px; width:100%; background:#b8860b; color:white; border:2px solid #d4af37; cursor:pointer; border-radius:6px; }
.validate-btn:disabled { opacity:.5; cursor:not-allowed; }

/* --- INPUT SECTION --- */
.input-section { display:none; margin-top:14px; padding-top:12px; border-top:2px solid #8b7355; }
.input-section.visible { display:block; }
.input-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(80px,1fr)); gap:10px; }
.confirm-btn { padding:10px; margin-top:12px; width:100%; background:#2d5016; border:2px solid #6ba53d; color:white; cursor:pointer; border-radius:6px; }

/* --- HISTORY W/ ACCORDION --- */
.history-wrapper { margin-bottom:20px; }
.history-block { overflow:hidden; transition:max-height 0.45s ease, opacity 0.45s ease; }
.history-item { background:rgba(255,255,255,0.05); padding:10px; margin-bottom:10px; border-left:3px solid #d4af37; border-radius:4px; }
.toggle-btn { cursor:pointer; color:#d4af37; text-align:center; display:block; margin-top:8px; }

/* --- STATISTICS --- */
.stats-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(130px,1fr)); gap:10px; }
.stat-item { background:rgba(255,255,255,0.05); padding:12px; border-radius:6px; border:1px solid #8b7355; text-align:center; }
.crit-success { color:#6be36b; font-weight:bold; }
.crit-fail { color:#ff6b6b; font-weight:bold; }

/* small screens */
@media (max-width:600px){ .dice-icon{width:56px;height:56px} }
</style>
</head>
<body>
<h1>üçÄ Guuak's bad Luck Tracker üçÄ</h1>

<!-- TABS -->
<div class="tabs">
    <div class="tab active" data-tab="lancer">üé≤ Lancer</div>
    <div class="tab" data-tab="guuak">üéÖüèº Guuak</div>
    <div class="tab" data-tab="aurelas">üßô Aurelas</div>
    <div class="tab" data-tab="edgaar">üë± Edgaar</div>
    <div class="tab" data-tab="menestrels">‚≠ê M√©nestrels</div>
</div>

<!-- SECTION LANCER -->
<div class="section active" id="section-lancer">
    <h2 class="section-title">üé≤ Lancer les d√©s</h2>

    <div class="dice-container">
        <div class="dice-item">
            <div class="dice-icon" data-dice="d4">D4</div>
            <div class="dice-controls">
                <button class="arrow-btn minus-btn" data-dice="d4">‚àí</button>
                <span class="dice-count" data-count="d4">0</span>
                <button class="arrow-btn plus-btn" data-dice="d4">+</button>
            </div>
        </div>

        <div class="dice-item">
            <div class="dice-icon" data-dice="d6">D6</div>
            <div class="dice-controls">
                <button class="arrow-btn minus-btn" data-dice="d6">‚àí</button>
                <span class="dice-count" data-count="d6">0</span>
                <button class="arrow-btn plus-btn" data-dice="d6">+</button>
            </div>
        </div>

        <div class="dice-item">
            <div class="dice-icon" data-dice="d8">D8</div>
            <div class="dice-controls">
                <button class="arrow-btn minus-btn" data-dice="d8">‚àí</button>
                <span class="dice-count" data-count="d8">0</span>
                <button class="arrow-btn plus-btn" data-dice="d8">+</button>
            </div>
        </div>

        <div class="dice-item">
            <div class="dice-icon" data-dice="d20">D20</div>
            <div class="dice-controls">
                <button class="arrow-btn minus-btn" data-dice="d20">‚àí</button>
                <span class="dice-count" data-count="d20">0</span>
                <button class="arrow-btn plus-btn" data-dice="d20">+</button>
            </div>
        </div>

        <div class="dice-item">
            <div class="dice-icon" data-dice="d100">D100</div>
            <div class="dice-controls">
                <button class="arrow-btn minus-btn" data-dice="d100">‚àí</button>
                <span class="dice-count" data-count="d100">0</span>
                <button class="arrow-btn plus-btn" data-dice="d100">+</button>
            </div>
        </div>
    </div>

    <div style="margin-top:10px; text-align:center;">
        <button class="player-button" data-player="guuak">üéÖüèº GUUAK</button>
        <button class="player-button" data-player="aurelas">üßô AURELAS</button>
        <button class="player-button" data-player="edgaar">üë± EDGA√ÑR</button>
    </div>

    <button id="validateBtn" class="validate-btn" disabled>Valider la s√©lection</button>

    <div class="input-section" id="inputSection">
        <div class="input-grid" id="inputGrid"></div>
        <button id="confirmBtn" class="confirm-btn">Enregistrer les r√©sultats</button>
    </div>
</div>

<!-- PLAYER SECTIONS -->
<div class="section" id="section-guuak">
    <h2 class="section-title">GUUAK</h2>
    <div class="history-wrapper" id="history-wrapper-guuak"></div>
    <h3 style="text-align:center;color:#d4af37;margin-top:18px;">üìä Statistiques</h3>
    <div class="stats-grid" id="stats-guuak"></div>
</div>

<div class="section" id="section-aurelas">
    <h2 class="section-title">AURELAS</h2>
    <div class="history-wrapper" id="history-wrapper-aurelas"></div>
    <h3 style="text-align:center;color:#d4af37;margin-top:18px;">üìä Statistiques</h3>
    <div class="stats-grid" id="stats-aurelas"></div>
</div>

<div class="section" id="section-edgaar">
    <h2 class="section-title">EDGA√ÑR</h2>
    <div class="history-wrapper" id="history-wrapper-edgaar"></div>
    <h3 style="text-align:center;color:#d4af37;margin-top:18px;">üìä Statistiques</h3>
    <div class="stats-grid" id="stats-edgaar"></div>
</div>

<!-- M√âNESTRELS -->
<div class="section" id="section-menestrels">
    <h2 class="section-title">‚≠ê Les 3 M√©nestrels ‚≠ê</h2>
    <p style="text-align:center;color:#a89968;font-style:italic;">Statistiques combin√©es</p>
    <div class="stats-grid" id="stats-menestrels"></div>
</div>

<script>
// Execute only after DOM ready to avoid null references
document.addEventListener('DOMContentLoaded', function(){
    /* =============================
       INITIAL STATE
    ============================= */
    const state = {
        selectedPlayer:null,
        diceSelection:{ d4:0,d6:0,d8:0,d20:0,d100:0 },
        playerData: JSON.parse(localStorage.getItem("dndDiceData") || "{}")
    };
    ['guuak','aurelas','edgaar'].forEach(p=>{ if(!state.playerData[p]) state.playerData[p]=[]; });

    // DOM refs
    const validateBtn = document.getElementById('validateBtn');
    const inputSection = document.getElementById('inputSection');
    const inputGrid = document.getElementById('inputGrid');
    const confirmBtn = document.getElementById('confirmBtn');

    /* =============================
       TAB SYSTEM
    ============================= */
    document.querySelectorAll('.tab').forEach(tab=>{
        tab.addEventListener('click',()=>{
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            const target = tab.getAttribute('data-tab');
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            const targetEl = document.getElementById(`section-${target}`);
            if(targetEl) targetEl.classList.add('active');
        });
    });

    /* =============================
       DICE SELECTION
    ============================= */
    function updateDiceDisplay(){
        Object.keys(state.diceSelection).forEach(d=>{
            const countEl = document.querySelector(`[data-count="${d}"]`);
            if(countEl) countEl.textContent = state.diceSelection[d];
            const icon = document.querySelector(`.dice-icon[data-dice="${d}"]`);
            if(icon){
                if(state.diceSelection[d]>0) icon.classList.add('selected');
                else icon.classList.remove('selected');
            }
        });
        validateBtn.disabled = !(state.selectedPlayer && Object.values(state.diceSelection).some(v=>v>0));
    }

    document.querySelectorAll('.plus-btn').forEach(btn=>btn.addEventListener('click',()=>{
        const d = btn.dataset.dice;
        state.diceSelection[d]++;
        updateDiceDisplay();
    }));

    document.querySelectorAll('.minus-btn').forEach(btn=>btn.addEventListener('click',()=>{
        const d = btn.dataset.dice;
        if(state.diceSelection[d]>0) state.diceSelection[d]--;
        updateDiceDisplay();
    }));

    /* =============================
       PLAYER SELECTION
    ============================= */
    document.querySelectorAll('.player-button').forEach(btn=>btn.addEventListener('click',()=>{
        state.selectedPlayer = btn.dataset.player;
        document.querySelectorAll('.player-button').forEach(b=>b.style.opacity=.5);
        btn.style.opacity=1;
        state.diceSelection={ d4:0,d6:0,d8:0,d20:0,d100:0 };
        updateDiceDisplay();
    }));

    /* =============================
       VALIDATE & INPUT FORM
    ============================= */
    validateBtn.addEventListener('click', ()=>{
        inputGrid.innerHTML='';
        Object.entries(state.diceSelection).forEach(([dice,count])=>{
            for(let i=1;i<=count;i++){
                const wrap = document.createElement('div');
                const label = document.createElement('label');
                label.textContent = `${dice.toUpperCase()} #${i}`;
                const input = document.createElement('input');
                input.type = 'number'; input.min = 1; input.dataset.dice = dice;
                wrap.appendChild(label); wrap.appendChild(input);
                inputGrid.appendChild(wrap);
            }
        });
        inputSection.classList.add('visible');
    });

    /* =============================
       SAVE RESULTS
    ============================= */
    confirmBtn.addEventListener('click', ()=>{
        const inputs = inputGrid.querySelectorAll('input');
        const rolls={};
        let valid=true;

        inputs.forEach(inp=>{
            const v = parseInt(inp.value);
            const d = inp.dataset.dice;
            if(isNaN(v) || v<1){ valid=false; inp.style.borderColor='red'; }
            else{
                inp.style.borderColor='';
                if(!rolls[d]) rolls[d]=[];
                rolls[d].push(v);
            }
        });
        if(!valid){ alert("Valeurs invalides"); return; }

        state.playerData[state.selectedPlayer].push({ timestamp:new Date().toLocaleString('fr-FR'), rolls });
        localStorage.setItem('dndDiceData', JSON.stringify(state.playerData));
        inputSection.classList.remove('visible');
        state.diceSelection={ d4:0,d6:0,d8:0,d20:0,d100:0 };
        updateDiceDisplay();
        refreshAll();
    });

    /* =============================
       HISTORY + ACCORDION
    ============================= */
    function renderHistory(player){
        const container = document.getElementById(`history-wrapper-${player}`);
        const data = state.playerData[player];
        if(!data.length){ container.innerHTML = "<p>Aucun lancer...</p>"; return; }

        const last3 = data.slice(-3).reverse();
        const rest = data.slice(0,-3).reverse();

        let html = "<div class='history-block' id='hb-"+player+"' style='max-height:500px;opacity:1;'>";
        last3.forEach(e=> html += formatRoll(e));
        html += "</div>";

        if(rest.length){
            html += `<div class='history-block hidden' id='hb-full-${player}' style='max-height:0;opacity:0;'>`;
            rest.forEach(e=> html += formatRoll(e));
            html += `</div>`;
            html += `<span class='toggle-btn' data-target='${player}'>üîΩ Afficher tout l'historique</span>`;
        }
        container.innerHTML = html;

        if(rest.length){
            const btn = container.querySelector('.toggle-btn');
            const block = container.querySelector(`#hb-full-${player}`);
            btn.onclick = ()=>{
                const hidden = block.classList.contains('hidden');
                if(hidden){
                    block.classList.remove('hidden');
                    block.style.maxHeight = block.scrollHeight+'px';
                    block.style.opacity = 1;
                    btn.textContent = "üîº R√©duire l'historique";
                } else {
                    block.style.maxHeight = '0px';
                    block.style.opacity = 0;
                    setTimeout(()=> block.classList.add('hidden'), 450);
                    btn.textContent = "üîΩ Afficher tout l'historique";
                }
            };
        }
    }

    function formatRoll(r){
        let s = "<div class='history-item'>";
        for(const [d,vals] of Object.entries(r.rolls)){
            s += `<b>${d.toUpperCase()}</b>: ${vals.join(', ')}<br>`;
        }
        s += `<div style='color:#a89968;font-size:0.85em;margin-top:4px;'>${r.timestamp}</div>`;
        s += "</div>";
        return s;
    }

    /* =============================
       STATS
    ============================= */
    function computeStats(values){
        const s=[...values].sort((a,b)=>a-b);
        const avg = s.reduce((a,b)=>a+b,0)/s.length;
        const mid = Math.floor(s.length/2);
        const median = s.length%2? s[mid] : (s[mid-1]+s[mid])/2;
        const variance = s.reduce((a,v)=>a+(v-avg)*(v-avg),0)/s.length;
        return { avg:avg.toFixed(1), median, std:Math.sqrt(variance).toFixed(2) };
    }

    function updateStats(player){
        const grid = document.getElementById(`stats-${player}`);
        const data = state.playerData[player];
        const agg = { d4:[],d6:[],d8:[],d20:[],d100:[] };
        let cs=0, cf=0;
        data.forEach(e=>{
            for(const [d,vals] of Object.entries(e.rolls)){
                agg[d].push(...vals);
                if(d==="d20") vals.forEach(v=>{ if(v===20)cs++; if(v===1)cf++; });
            }
        });
        let html = `<div class='stat-item'><div class='crit-success'>Succ√®s Critiques</div>${cs}</div>`;
        html += `<div class='stat-item'><div class='crit-fail'>√âchecs Critiques</div>${cf}</div>`;
        for(const [d,vals] of Object.entries(agg)){
            if(!vals.length) continue;
            const st = computeStats(vals);
            html += `<div class='stat-item'><b>${d.toUpperCase()}</b><br>Moy: ${st.avg}<br>M√©d: ${st.median}<br>œÉ: ${st.std}</div>`;
        }
        grid.innerHTML = html;
    }

    /* =============================
       MENESTRELS
    ============================= */
    function updateMenestrels(){
        const grid = document.getElementById('stats-menestrels');
        const players=['guuak','aurelas','edgaar'];
        const agg={ d4:[],d6:[],d8:[],d20:[],d100:[] };
        let cs=0,cf=0;
        players.forEach(p=>{
            state.playerData[p].forEach(e=>{
                for(const [d,vals] of Object.entries(e.rolls)){
                    agg[d].push(...vals);
                    if(d==="d20") vals.forEach(v=>{ if(v===20)cs++; if(v===1)cf++; });
                }
            });
        });
        let html = `<div class='stat-item'><div class='crit-success'>Succ√®s Critiques</div>${cs}</div>`;
        html += `<div class='stat-item'><div class='crit-fail'>√âchecs Critiques</div>${cf}</div>`;
        for(const [d,vals] of Object.entries(agg)){
            if(!vals.length) continue;
            const st = computeStats(vals);
            html += `<div class='stat-item'><b>${d.toUpperCase()}</b><br>Moy: ${st.avg}<br>M√©d: ${st.median}<br>œÉ: ${st.std}</div>`;
        }
        grid.innerHTML = html;
    }

    /* =============================
       REFRESH ALL
    ============================= */
    function refreshAll(){
        ['guuak','aurelas','edgaar'].forEach(p=>{
            renderHistory(p);
            updateStats(p);
        });
        updateMenestrels();
        // re-apply any UI niceties if needed
    }

    // initial render
    refreshAll();
}); // DOMContentLoaded
</script>

</body>
</html>
